<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Days Mini App</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="shop" class="tab active">
    <h2>Магазин</h2>
    <div class="item">Happy Day - 15 монет <button class="button" onclick="buyToken('happy_day')">Купить</button></div>
    <div class="item">Sad Day - 50 монет (Ограничено) <button class="button" onclick="buyToken('sad_day')">Купить</button></div>
  </div>
  <div id="profile" class="tab">
    <h2>Профиль</h2>
    <p>Баланс: <span id="balance"></span> монет</p>
    <p>Твои токены: <span id="tokens"></span></p>
    <button class="button" onclick="sendToken()">Отправить токен</button>
  </div>
  <div class="tabs">
    <button onclick="switchTab('shop')">Магазин</button>
    <button onclick="switchTab('profile')">Профиль</button>
  </div>

  <script>
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
    }

    window.Telegram.WebApp.ready();
    const user = window.Telegram.WebApp.initDataUnsafe.user || { id: 'test_user' };
    const host = window.location.origin; // Динамический хост для Render

    async function buyToken(tokenType) {
      const response = await fetch(`${host}/buy?userId=${user.id}&token=${tokenType}`, { method: 'POST' });
      const data = await response.json();
      if (data.success) {
        alert('Токен куплен! Проверь профиль.');
        updateProfile();
      } else {
        alert('Ошибка: ' + data.error);
      }
    }

    async function sendToken() {
      const token = prompt('Какой токен отправить? (happy_day или sad_day)');
      if (token) {
        const response = await fetch(`${host}/send?userId=${user.id}&token=${token}`, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          alert('Токен отправлен!');
          updateProfile();
        } else {
          alert('Ошибка: ' + data.error);
        }
      }
    }

    async function updateProfile() {
      const response = await fetch(`${host}/profile?userId=${user.id}`);
      const data = await response.json();
      document.getElementById('balance').innerText = data.balance;
      document.getElementById('tokens').innerText = data.tokens.join(', ') || 'Нет токенов';
    }

    updateProfile();
  </script>
</body>
</html>